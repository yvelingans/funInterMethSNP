---
title: "Detecting SNP–Methylation Interactions on phenotypes with funInterMethSNP"
author:
  - name: Yvelin Gansou
    affiliation: Université Laval, Québec, Canada
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    number_sections: false
bibliography: funInterMethSNP.bib
vignette: >
  %\VignetteIndexEntry{Detecting SNP–Methylation Interactions on phenotypes with funInterMethSNP}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
date: "`r Sys.Date()`"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(funInterMethSNP)
```

# Installation 


The `funInterMethSNP`  package can be installed from GitHub using :

```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("yvelingans/funInterMethSNP")
```

# Introduction

**funInterMethSNP** aims to test the overall interaction effect between DNA methylation profiles  and SNP genotypes (treated as discrete variables), for outcomes that are continuous, binary, or belong to the exponential family (e.g., Poisson). To achieve this, we model methylation data as functional variable and develop flexible functional regression models capable of capturing their interactions with SNPs.

Major advantages of **funInterMethSNP** include:
- Avoiding multiple testing by assessing the global SNP–CpG interaction effect rather than testing each SNP–CpG pair separately.
- Accounting for spatial correlations between methylation values of neighboring CpG sites.
- Enabling flexible detection of interaction effects using a parameter $\rho$ that controls the window of CpG sites around each SNP, thereby allowing stronger weighting of nearby CpGs and emphasizing localized effects.


It implements the following functions : 
- `estim_methyl_curve()`
- `fitMethSNPfunctInter_continu()`  
- `fitMethSNPfunctInter_generalized()`  
- `fitMethSNPfunctInter_ordinal()` *(coming soon)*

These functions rely on generalized additive  models  to estimate effects and test the global interaction through either a Wald test or a likelihood ratio test.
For a more comprehensive introduction to the **funInterMethSNP** approach, please refer to our paper [@gansou2025].


## Model overview  

The models implemented in **funInterMethSNP** aim to test whether there exists a **global interaction effect** between methylation profiles and SNPs on a phenotype \(Y_i\).  
Methylation levels are represented as smooth functional trajectories \(\Pi_i(t)\), while SNPs are treated as discrete variables \(G_{id} \in \{0,1,2\}\).  

Formally, the general model can be written as:  

\[
g(\mathbb{E}[Y_i]) \;=\; \zeta_0 + \sum_{s=1}^S \zeta_s W_{is} \;+\; \sum_{d=1}^D \alpha_d G_{id} \;+\; \int_0^1 \delta(t)\,\Pi_i(t)\,dt \;+\; \sum_{d=1}^D \eta_d G_{id} \int_0^1 \psi_{\rho}(|t - u_d|)\,\Pi_i(t)\,dt,
\]

where:  
- \(g(\cdot)\) is a suitable link function (identity, logit, log, …),  
- \(W_{is}\) are covariates with effects \(\zeta_s\),  
- \(\alpha_d\) are the main effects of SNPs,  
- \(\delta(t)\) is the functional coefficient associated with methylation,  
- \(\eta_d\) are interaction coefficients to be estimated,  
- \(\psi_{\rho}(|t - u_d|)\) is a weighting kernel emphasizing CpGs close to SNP \(d\).  

The global hypothesis of interest is whether all interaction coefficients are simultaneously null, i.e.  

\[
H_0 : \eta_1 = \eta_2 = \cdots = \eta_D = 0.
\]

This test is carried out using either a Wald test or a likelihood ratio test.

# Application

Throughout this vignette, we illustrate the **funInterMethSNP** approach using example datasets derived from the real dataset GSE73103, available on GEO. For more details about the dataset, see [@voisin2015many].


# Input data

To illustrate the capabilities of the **funInterMethSNP** package, we provide several example datasets that include both real and simulated components. These datasets are loaded using the `data(...)` function.

- The response vector `resp_continu` is a continuous variable, simulated under our proposed model using chosen parameter values.  
- The DNA methylation data `data_methylation_raw` consists of real beta values ranging between 0 and 1, extracted from the public dataset GSE73103 (available on GEO).
- The genotype matrix `mat_snp` contains SNP genotypes coded as 0, 1, or 2. It is also derived from the GSE73103 dataset.
- The covariate matrix `mat_covar` includes potential confounders such as age and sex, based on real data from the same study.

To demonstrate the use of our model in a binary context, we also provide `resp_binaire`, a dichotomized response variable indicating obesity status: 0 for normal weight and 1 for overweight or obese individuals. This variable was derived from the weight data in GSE73103.

Lastly, to illustrate our model with other members of the exponential family, we include a Poisson-type response variable `resp_pois`. This variable was simulated based on our model.

These datasets can be loaded and previewed as follows:

```{r load_data}
data(data_methylation_raw)
data(mat_snp)
data(mat_covar)
data(resp_continu)
data(resp_pois)
data(resp_binaire)
data("mat_methyl")
data("pos_snp")

head(data_methylation_raw[,1:10])
head(mat_snp)
head(mat_covar)
```

The functions implemented in **funInterMethSNP** rely on the penalized regression framework provided by the functions gamm() and gam() from the mgcv package [@wood2015package].
 

---

# Analysis and result  

The package `funInterMethSNP` provides functions to fit functional regression models with SNP–methylation interactions.  
The typical workflow includes two steps:  

1. **Estimating methylation curves** from raw CpG-methylation  data using `estim_methyl_curve()`.  
2. **Model fitting** with:  
   - `fitMethSNPfunctInter_continu()` for continuous outcomes,  
   - `fitMethSNPfunctInter_generalized()` for binary and other outcomes whose distributions belong to the exponential family 

## Estimating methylation curves  

Raw methylation levels (e.g., beta-values or the proportion of methylated cytosines) are first transformed into smooth functional trajectories using  using the function `estim_methyl_curve()`. This procedure applies adaptive Gaussian kernel smoothing ([@hansen2012bsmooth,@lakhal2017smoothed]) to CpG sites within a genomic region of interest.  

### Parameters  


- **`mat_methylation_raw`**: Data frame of raw methylation beta values.  
  - Rows = CpG sites.  
  - Columns = individuals, with one additional column `"Position"` giving the genomic coordinate (in base pairs) of each CpG.  
  - Example: a dataset with 500 CpGs measured in the genomic region of interest on 10 individuals will have 500 rows and 11 columns (10 individuals + `"Position"`).  

- **`H`**: Minimum bandwidth (in base pairs) for adaptive Gaussian kernel smoothing.  
  - Default: 1000 bp.  

- **`region_range`**: Numeric vector of length 2 specifying the genomic window of interest, e.g. `c(11190000, 11460000)`.  
  - Only CpGs falling inside this interval are used.  
  - This ensures that all individuals are compared over the same genomic segment.  

- **`RGN`**: Numeric vector defining the grid of normalized positions in \([0,1]\) where the methylation curves are evaluated. Each normalized point is mapped to its corresponding genomic coordinate (in base pairs) within the region of interest.

### Output  
The function returns a **matrix**:  
- Rows = individuals.  
- Columns = grid points in `RGN`.  
- Values in \([0,1]\) represent the estimated methylation proportion at each normalized CpG position within the genomic window.  

Thus, each row corresponds to one individual’s smoothed methylation curve. These functional representations serve as inputs for the interaction models in `fitMethSNPfunctInter_*()`.  

### Example and visualization

```{r, eval=FALSE}
# Estimate methylation curves from example dataset
mat_methyl <- estim_methyl_curve(
  mat_methylation_raw = data_methylation_raw,
  region_range = c(min(data_methylation_raw$Position),
                   max(data_methylation_raw$Position))
)
```

```{r,fig.height=5, fig.width=5}
# Plot smoothed methylation curves for 3 random individuals
set.seed(123)
inds <- sample(1:nrow(mat_methyl), 3)

# Plot smoothed methylation curves for 3 random individuals
set.seed(123)
inds <- sample(1:nrow(mat_methyl), 3)

# Plot the first individual
plot(
  x = seq(0, 1, length.out = ncol(mat_methyl)),
  y = mat_methyl[inds[1], ],
  type = "l", col = 1,
  ylim = c(0, 1),
  xlab = "Normalized genomic position",
  ylab = "Methylation level",
  main = "Smoothed methylation curves (3 individuals)"
)

# Add the other individuals
lines(seq(0, 1, length.out = ncol(mat_methyl)), mat_methyl[inds[2], ], col = 2)
lines(seq(0, 1, length.out = ncol(mat_methyl)), mat_methyl[inds[3], ], col = 3)

# Add legend
legend("topright",
       legend = paste("Ind", inds),
       col = 1:3, lty = 1, lwd = 1, cex = 0.6
)
```

## Continuous outcome

We first illustrate the continuous case with a response vector `resp_continu`:

```{r, eval=FALSE}
fit_cont <- fitMethSNPfunctInter_continu(
  Y = resp_continu,
  W = mat_covar,
  G = mat_snp,
  mat_methyl = mat_methyl,
  pos_snp = pos_snp,
  rho = 10,
  nb_fct = 10,
  kernel_name = "convex",
  region_range = c(min(data_methylation_raw$Position),
                   max(data_methylation_raw$Position)),
  RGN = seq(0, 1, length.out = ncol(mat_methyl))
)

# Inspect results
summary(fit_cont$object_gam)
plot(fit_cont$object_gam)
```

### Interpretation

Running the code above yields, for instance :

 

The global interaction test (`fit_cont$pvalue`) yields a p-value of **0.017**, providing evidence of a significant SNP–methylation interaction effect on the continuous response.  
- The estimated smoothing parameter (\(\lambda \approx 10.84\)) reflects the degree of penalization applied to the functional methylation term; larger values correspond to smoother estimated effects.  
- The residual variance (\(\sigma^2 \approx 5.28\)) measures the variability in the phenotype not explained by SNPs, methylation, or covariates.  
- Interaction coefficients \(\eta_d\) (from `fit_cont$teta`) are:  
  - `inter_meth_rs984222`: **180.62**  
  - `inter_meth_rs2815752`: **67.24**  
  - `inter_meth_rs3934834`: **1173.54**  
  - `inter_meth_rs1514175`: **24.15**  
  - `inter_meth_rs10783050`: **−21.92**  

These coefficients highlight heterogeneity across SNPs. In particular, SNP *rs3934834* shows a much stronger interaction effect compared to the others, while some SNPs contribute only marginally or even negatively.  

This example illustrates that the method not only detects the global presence of an interaction but also identifies which SNPs contribute most strongly to the overall signal.
 

Users can also further inspect the model:  

```{r, eval=FALSE}
summary(fit_cont$object_gam)  # individual parameter testing
plot(fit_cont$object_gam)     # functional effect of methylation
```

## Binary outcome

For a binary phenotype (`resp_binaire`), we use the logistic link:

```{r, eval=FALSE}
fit_bin <- fitMethSNPfunctInter_generalized(
  Y = resp_binaire,
  W = mat_covar,
  G = mat_snp,
  mat_methyl = mat_methyl,
  pos_snp = pos_snp,
  family = binomial(link = "logit"),
  rho = 10,
  nb_fct = 10,
  kernel_name = "convex",
  region_range = c(min(data_methylation_raw$Position),
                   max(data_methylation_raw$Position)),
  RGN = seq(0, 1, length.out = ncol(mat_methyl))
)

# Inspect results
summary(fit_bin$object_gam)
plot(fit_bin$object_gam)
```



### Interpretation

 


Running the code above yields, for instance :

- `fit_bin$pvalue`: Likelihood ratio test p-value = **0.013**, indicating a significant SNP–methylation interaction effect on obesity status.  
- The estimated smoothing parameter (\(\lambda \approx 1.33\)) indicates a moderate level of penalization.  
- Interaction coefficients \(\eta_d\) (from `fit_bin$teta`) are:  
  - `inter_meth_rs984222`: **248.63**  
  - `inter_meth_rs2815752`: **99.10**  
  - `inter_meth_rs3934834`: **1269.77**  
  - `inter_meth_rs1514175`: **23.07**  
  - `inter_meth_rs10783050`: **−41.36**  

These estimates reveal substantial variability in the magnitude and direction of SNP–methylation interaction effects. In particular, SNP *rs3934834* again shows the strongest contribution, while some SNPs exert weaker or even negative effects.  

This example demonstrates the ability of the method to detect and characterize meaningful SNP–methylation interactions in binary outcomes.

Users can further explore the fitted model with:  

```{r, eval=FALSE}
summary(fit_bin$object_gam)  # individual parameter statistics
plot(fit_bin$object_gam)     # functional interaction curve
```


---

## Poisson outcome

Finally, we consider a simulated count response (`resp_pois`):

```{r, eval=FALSE}
fit_pois <- fitMethSNPfunctInter_generalized(
  Y = resp_pois,
  W = mat_covar,
  G = mat_snp,
  mat_methyl = mat_methyl,
  pos_snp = pos_snp,
  family = poisson(link = "log"),
  rho = 10,
  nb_fct = 10,
  kernel_name = "convex",
  region_range = c(min(data_methylation_raw$Position),
                   max(data_methylation_raw$Position)),
  RGN = seq(0, 1, length.out = ncol(mat_methyl))
)

# Inspect results
summary(fit_pois$object_gam)
plot(fit_pois$object_gam)
```
 

### Interpretation

Running the code above yields, for instance :
 
 

The global interaction test (`fit_pois$pvalue`) yields a p-value of **3.13 × 10⁻⁹**, providing strong evidence of a significant SNP–methylation interaction effect on the expected count response.  
- The very small p-value confirms the sensitivity of the method in detecting interactions in count-type outcomes.  
- Interaction coefficients \(\eta_d\) (from `fit_pois$teta`) are:  
  - `inter_meth_rs984222`: **−56.42**  
  - `inter_meth_rs2815752`: **19.45**  
  - `inter_meth_rs3934834`: **−199.00**  
  - `inter_meth_rs1514175`: **−4.46**  
  - `inter_meth_rs10783050`: **48.16**  

These coefficients again demonstrate heterogeneity across SNPs, with some showing strong positive or negative contributions to the interaction effect.  

This example highlights the flexibility of the `funInterMethSNP` framework, which can be applied consistently across different outcome types from the exponential family. In particular, it confirms that localized SNP–methylation interactions can have a measurable impact even on discrete count responses.


 
